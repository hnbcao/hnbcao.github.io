<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="常用关键字 #  2.1. Select #  2.1.1. 实现原理 #    直接阻塞：空 select 语句；空的 select 语句会直接阻塞当前的 Goroutine，导致 Goroutine 进入无法被唤醒的永久休眠状态。
  单一管道：select 条件只包含一个 case；如果当前的 select 条件只包含一个 case，当 case 中的 Channel 是空指针时，就会直接挂起当前 Goroutine 并永久休眠。
  非阻塞操作：当 select 中仅包含两个 case，并且其中一个是 default 时，Go 语言的编译器就会认为这是一次非阻塞的收发操作。如果 select 控制结构中包含 default 语句，那么这个 select 语句在执行时会遇到以下两种情况：
1.当存在可以收发的 Channel 时，直接处理该 Channel 对应的 case；
2.当不存在可以收发的 Channel 是，执行 default 中的语句；
当我们运行下面的代码时就不会阻塞当前的 Goroutine，它会直接执行 default 中的代码并返回。
func main() { ch := make(chan int) select { case i := &lt;-ch: println(i) default: println(&#34;default&#34;) } }   2.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="2. 常用关键字" />
<meta property="og:description" content="常用关键字 #  2.1. Select #  2.1.1. 实现原理 #    直接阻塞：空 select 语句；空的 select 语句会直接阻塞当前的 Goroutine，导致 Goroutine 进入无法被唤醒的永久休眠状态。
  单一管道：select 条件只包含一个 case；如果当前的 select 条件只包含一个 case，当 case 中的 Channel 是空指针时，就会直接挂起当前 Goroutine 并永久休眠。
  非阻塞操作：当 select 中仅包含两个 case，并且其中一个是 default 时，Go 语言的编译器就会认为这是一次非阻塞的收发操作。如果 select 控制结构中包含 default 语句，那么这个 select 语句在执行时会遇到以下两种情况：
1.当存在可以收发的 Channel 时，直接处理该 Channel 对应的 case；
2.当不存在可以收发的 Channel 是，执行 default 中的语句；
当我们运行下面的代码时就不会阻塞当前的 Goroutine，它会直接执行 default 中的代码并返回。
func main() { ch := make(chan int) select { case i := &lt;-ch: println(i) default: println(&#34;default&#34;) } }   2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hnbcao.vip/docs/golang/basic/keyword/" /><meta property="article:section" content="docs" />



<title>2. 常用关键字 | HNBCAO</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e17ad8ce61aee52ff95c08d23607efba0cbf6cb70820abe7a05c9159c5185ce1.css" integrity="sha256-4XrYzmGu5S/5XAjSNgfvugy/bLcIIKvnoFyRWcUYXOE=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.7257b5c1bdab5b451d20769c862f47f9503142bf05e5d13863af77dbcda197fa.js" integrity="sha256-cle1wb2rW0UdIHachi9H&#43;VAxQr8F5dE4Y693282hl/o=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>HNBCAO</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Golang学习笔记</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1c612c7b4b8439389939ab8807294c71" class="toggle" checked />
    <label for="section-1c612c7b4b8439389939ab8807294c71" class="flex justify-between">
      <a role="button" class="">基础知识</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/golang/basic/basic/" class="">1. 语言基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/golang/basic/keyword/" class=" active">2. 常用关键字</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-cb87749ee672152a5caec4a87698c2a8" class="toggle"  />
    <label for="section-cb87749ee672152a5caec4a87698c2a8" class="flex justify-between">
      <a role="button" class="">运行时</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/golang/runtime/context/" class="">1. 上下文 Context</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/golang/runtime/mutex/" class="">2. 同步原语与锁</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-08b535e490eca27ad24a819af5f72970" class="toggle"  />
    <label for="section-08b535e490eca27ad24a819af5f72970" class="flex justify-between">
      <a role="button" class="">进阶知识</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/golang/advanced/escape_analysis/" class="">1. 逃逸分析</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>容器化</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-de0837145b8d41bd524e86425c79ce30" class="toggle"  />
    <label for="section-de0837145b8d41bd524e86425c79ce30" class="flex justify-between">
      <a role="button" class="">Docker</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/docker/docker-compose-installation/" class="">Docker Compose安装使用</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c9c13742e83e082551e7692418cffc0e" class="toggle"  />
    <label for="section-c9c13742e83e082551e7692418cffc0e" class="flex justify-between">
      <a role="button" class="">Kubernetes</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/1-kubernetes-cluster-installation/" class="">Kubernetes集群安装</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/2-kubernetes-cert-manager/" class="">Kubernetes集群安装Cert Manager</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/3-kubernetes-traefik-ingress/" class="">Kubernetes集群安装Traefik Ingress</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/4-create-kubernetes-user/" class="">Kubernetes集群创建用户</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/5-kubernetes-create-image-pull-secret/" class="">Kubernetes集群创建Image Pull Secret</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/6-kubernetes-seo/" class="">kubernetes集群运行问题记录</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/container/kubernetes/7-kubernetes-with-aliyungpu/" class="">Kubernetes集群GPU共享解决方案</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>运维管理</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2fdb1b25835f7654408a6759bed146e9" class="toggle"  />
    <label for="section-2fdb1b25835f7654408a6759bed146e9" class="flex justify-between">
      <a role="button" class="">操作系统</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/system/create-offline-yum-repo/" class="">CentOS离线镜像仓库创建</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0bad6e65e759e297a009b1e26f924cc0" class="toggle"  />
    <label for="section-0bad6e65e759e297a009b1e26f924cc0" class="flex justify-between">
      <a role="button" class="">中间件</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/middleware/canal-installation/" class="">Canal安装部署</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/middleware/ceph-installation/" class="">Ceph集群安装</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/middleware/ftp-installation/" class="">FTP服务器搭建</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/middleware/fluent-bit-configuration/" class="">Fluent-bit日志插件配置说明</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/middleware/mysql-installation/" class="">Centos安装Mysql</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9eb246663d1aef22f58ce7aee5e54604" class="toggle"  />
    <label for="section-9eb246663d1aef22f58ce7aee5e54604" class="flex justify-between">
      <a role="button" class="">大数据</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/seo/bigdata/hive-sql/" class="">Hive操作指南</a>
  

        </li>
      
    
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>软件工程</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hnbcao.vip/docs/design/design-pattern/" class="">设计模式简介</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>2. 常用关键字</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#21-select">2.1. Select</a>
      <ul>
        <li><a href="#211-实现原理">2.1.1. 实现原理</a></li>
        <li><a href="#212-小结">2.1.2. 小结</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="常用关键字">
  常用关键字
  <a class="anchor" href="#%e5%b8%b8%e7%94%a8%e5%85%b3%e9%94%ae%e5%ad%97">#</a>
</h1>
<h2 id="21-select">
  2.1. Select
  <a class="anchor" href="#21-select">#</a>
</h2>
<h3 id="211-实现原理">
  2.1.1. 实现原理
  <a class="anchor" href="#211-%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86">#</a>
</h3>
<ul>
<li>
<p><strong>直接阻塞</strong>：空 select 语句；空的 select 语句会直接阻塞当前的 Goroutine，导致 Goroutine 进入无法被唤醒的永久休眠状态。</p>
</li>
<li>
<p><strong>单一管道</strong>：select 条件只包含一个 case；如果当前的 select 条件只包含一个 case，当 case 中的 Channel 是空指针时，就会直接挂起当前 Goroutine 并永久休眠。</p>
</li>
<li>
<p><strong>非阻塞操作</strong>：当 select 中仅包含两个 case，并且其中一个是 default 时，Go 语言的编译器就会认为这是一次非阻塞的收发操作。如果 select 控制结构中包含 default 语句，那么这个 select 语句在执行时会遇到以下两种情况：</p>
<p>1.当存在可以收发的 Channel 时，直接处理该 Channel 对应的 case；</p>
<p>2.当不存在可以收发的 Channel 是，执行 default 中的语句；</p>
<p>当我们运行下面的代码时就不会阻塞当前的 Goroutine，它会直接执行 default 中的代码并返回。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
  <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
  <span style="color:#66d9ef">select</span> {
  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
    println(<span style="color:#a6e22e">i</span>)

  <span style="color:#66d9ef">default</span>:
    println(<span style="color:#e6db74">&#34;default&#34;</span>)
  }
}
</code></pre></div></li>
</ul>
<h3 id="212-小结">
  2.1.2. 小结
  <a class="anchor" href="#212-%e5%b0%8f%e7%bb%93">#</a>
</h3>
<p>我们简单总结一下 select 结构的执行过程与实现原理，首先在编译期间，Go 语言会对 select 语句进行优化，它会根据 select 中 case 的不同选择不同的优化路径：</p>
<ol>
<li>
<p>空的 select 语句会被转换成调用 runtime.block 直接挂起当前 Goroutine；</p>
</li>
<li>
<p>如果 select 语句中只包含一个 case，编译器会将其转换成 if ch == nil { block }; n; 表达式；
首先判断操作的 Channel 是不是空的；
然后执行 case 结构中的内容；</p>
</li>
<li>
<p>如果 select 语句中只包含两个 case 并且其中一个是 default，那么会使用 runtime.selectnbrecv 和 runtime.selectnbsend 非阻塞地执行收发操作；</p>
</li>
<li>
<p>在默认情况下会通过 runtime.selectgo 获取执行 case 的索引，并通过多个 if 语句执行对应 case 中的代码；</p>
</li>
</ol>
<p>在编译器已经对 select 语句进行优化之后，Go 语言会在运行时执行编译期间展开的 runtime.selectgo 函数，该函数会按照以下的流程执行：</p>
<ol>
<li>
<p>随机生成一个遍历的轮询顺序 pollOrder 并根据 Channel 地址生成锁定顺序 lockOrder；</p>
</li>
<li>
<p>根据 pollOrder 遍历所有的 case 查看是否有可以立刻处理的 Channel；</p>
</li>
<li>
<p>如果存在，直接获取 case 对应的索引并返回；</p>
</li>
<li>
<p>如果不存在，创建 runtime.sudog 结构体，将当前 Goroutine 加入到所有相关 Channel 的收发队列，并调用 runtime.gopark 挂起当前 Goroutine 等待调度器的唤醒；</p>
</li>
<li>
<p>当调度器唤醒当前 Goroutine 时，会再次按照 lockOrder 遍历所有的 case，从中查找需要被处理的 runtime.sudog 对应的索引；</p>
</li>
</ol>
<p>select 关键字是 Go 语言特有的控制结构，它的实现原理比较复杂，需要编译器和运行时函数的通力合作。</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#21-select">2.1. Select</a>
      <ul>
        <li><a href="#211-实现原理">2.1.1. 实现原理</a></li>
        <li><a href="#212-小结">2.1.2. 小结</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












